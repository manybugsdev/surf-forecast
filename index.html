<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Waro</title>
    <style>
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        padding: 0;
        background-color: snow;
        min-height: 100dvh;
        display: flex;
        justify-content: center;
      }
      canvas {
        margin: auto;
        border: 1px solid black;
        width: min(100dvw, 100dvh);
        height: min(100dvh, 100dvw);
      }
    </style>
  </head>
  <body>
    <canvas id="canvas"></canvas>
    <script type="module">
      const FPS = 60;
      // グリッド列数
      const N = 16;

      // 波の速度(制約: c * dt / dh <= 1 / sqrt(2))
      const C = 0.4;
      // 波の減衰
      const G = 0.01;

      const dh = 1 / N;
      const dt = 1 / FPS;

      const around = (i, j) => [
        [i - 1, j],
        [i + 1, j],
        [i, j - 1],
        [i, j + 1],
      ];
      const array = (n, fn) => Array.from({ length: n }, fn);
      const range = (n) => array(n, (_, i) => i);
      const grid = (n, fn) => array(n, () => array(n, fn));
      const clamp = (n, min, max) => (n > max ? max : n < min ? min : n);
      const wave2rgba = (wave) =>
        [...wave, 1].map((c) => Math.floor(255 * Math.abs(c)));
      const updateStates = ({ wavesPre, waves }) => ({
        wavesPre: waves,
        waves: waves.map((row, i) =>
          row.map((w, j) =>
            w.map((u, k) => {
              const up = wavesPre[i][j][k];
              return (
                2 * u -
                up +
                Math.pow((C * dt) / dh, 2) *
                  around(i, j).reduce(
                    (sum, [i, j]) => sum + (waves[i]?.[j]?.[k] ?? 0),
                    -4 * u
                  ) -
                G * (u - up)
              );
            })
          )
        ),
      });
      const updateView = (ctx, { waves }) => {
        const imageData = ctx.createImageData(N, N);
        const flatten = waves.flat().flatMap(wave2rgba);
        const uint8array = new Uint8ClampedArray(flatten);

        imageData.data.set(uint8array);
        ctx.putImageData(imageData, 0, 0);
      };
      const loop = (fn, interval = 0) => {
        if (interval > 0) {
          setInterval(fn, interval);
          return;
        }
        const f = () => {
          fn();
          requestAnimationFrame(f);
        };
        requestAnimationFrame(f);
      };
      const canvasOnClick = (e, states) => {
        const [j, i] = [
          e.offsetX / e.target.clientWidth,
          e.offsetY / e.target.clientHeight,
        ].map((v) => Math.floor(v * N));
        states.waves[i][j] = [1, 1, 1];
        return states;
      };
      const main = () => {
        canvas.width = canvas.height = N;
        let states = {
          wavesPre: grid(N, () => [0, 0, 0]),
          waves: grid(N, () => [0, 0, 0]),
        };
        const ctx = canvas.getContext("2d");
        canvas.addEventListener(
          "click",
          (e) => (states = canvasOnClick(e, states))
        );

        loop(() => updateView(ctx, states));
        loop(() => (states = updateStates(states)), 1000 / FPS);
      };
      main();
    </script>
  </body>
</html>
